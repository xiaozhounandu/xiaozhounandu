<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>å®¢æˆ·ç®¡ç†ç³»ç»Ÿ</title>
    <style>
        /* CSS æ ·å¼ä¿æŒä¸å˜ */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            padding: 30px;
            background-color: #f4f7f6;
            color: #333;
        }

        h2, h3 {
            color: #007bff;
            border-bottom: 2px solid #e0e0e0;
            padding-bottom: 10px;
            margin-top: 20px;
        }

        /* å®¹å™¨æ ·å¼ */
        .card {
            background: #ffffff;
            padding: 20px;
            margin-bottom: 25px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        }

        /* æè¿°æ–‡æœ¬æ ·å¼ (æ›¿ä»£ label) */
        .input-description {
            font-weight: 500;
            color: #555;
            display: block;
            margin-bottom: 5px;
        }

        /* è¡¨å•å…ƒç´ å’ŒæŒ‰é’® */
        input[type="text"], input[type="number"], input[type="email"] {
            padding: 10px;
            margin: 0 0 10px 0;
            border: 1px solid #ccc;
            border-radius: 4px;
            width: 100%;
            box-sizing: border-box;
            transition: border-color 0.3s;
        }

        input:focus {
            border-color: #007bff;
            outline: none;
        }

        button {
            padding: 8px 12px;
            margin: 5px 5px 5px 0;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.3s, transform 0.1s;
            font-size: 0.9em;
        }

        /* æŒ‰é’®æ ·å¼ä¿æŒä¸å˜ */
        button[onclick^="get"], #insertBtn { background-color: #007bff; color: white; }
        #updateBtn { background-color: #28a745; color: white; }
        .action-edit { background-color: #ffc107; color: #333; margin-right: 5px;}
        .action-delete { background-color: #dc3545; color: white; }
        button:hover { opacity: 0.9; transform: translateY(-1px); }

        /* --- è¡¨æ ¼æ ·å¼ --- */

        .table-responsive {
            width: 100%;
            overflow-x: auto;
        }

        table {
            min-width: 1100px;
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            margin-top: 20px;
            background-color: #fff;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        }

        th, td {
            padding: 12px 15px;
            border-bottom: 1px solid #e0e0e0;
            white-space: nowrap;
        }

        th {
            background-color: #007bff;
            color: white;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            top: 0;
        }

        /* æ–‘é©¬çº¹å’Œæ‚¬åœæ•ˆæœ */
        tbody tr:nth-child(odd) { background-color: #f9f9f9; }
        tbody tr:nth-child(even) { background-color: #ffffff; }
        tbody tr:hover { background-color: #e9f0ff; cursor: pointer; }

        /* æ•°æ®å¯¹é½ä¼˜åŒ– */
        .text-center { text-align: center; }

        /* è¡¨æ ¼ç‰¹å®šåˆ—çš„å¯¹é½ */
        #customerTable th:nth-child(1), #customerTable td:nth-child(1),
        #customerTable th:nth-child(7), #customerTable td:nth-child(7),
        #customerTable th:nth-child(8), #customerTable td:nth-child(8),
        #customerTable th:nth-child(9), #customerTable td:nth-child(9)
        {
            text-align: center;
        }

        #customerTable th:last-child, #customerTable td:last-child {
            width: 120px;
            text-align: center;
        }


        /* è¡¨å•ç»„å¸ƒå±€ */
        .form-group {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
        }

        .input-container {
            flex-basis: calc(33.333% - 14px);
            display: flex;
            flex-direction: column;
            margin-bottom: 10px;
        }

        /* æŸ¥è¯¢åŒºåŸŸå¸ƒå±€ */
        .query-actions {
            display: flex;
            align-items: flex-end;
            gap: 15px;
            margin-bottom: 15px;
        }

        .query-actions .input-container {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            margin-bottom: 0;
            max-width: 250px; /* é™åˆ¶IDè¾“å…¥æ¡†å®½åº¦ */
        }

        .query-actions button {
            margin-bottom: 0;
            height: 40px;
        }

        #editingIdDisplay {
            font-weight: bold;
            color: #007bff;
            margin-left: 10px;
        }
    </style>
</head>
<body>

<h2>å®¢æˆ·ç®¡ç†ç³»ç»Ÿ</h2>

<div class="card">
    <h3>ğŸ” å®¢æˆ·æŸ¥è¯¢</h3>
    <div class="query-actions">
        <div class="input-container">
            <span class="input-description">å®¢æˆ· ID:</span>
            <input type="number" id="queryCustomerId" placeholder="è¾“å…¥å®¢æˆ· ID" />
        </div>
        <button onclick="getCustomerById()">æ ¹æ® ID æŸ¥è¯¢</button>
        <button onclick="getAllCustomers()">æŸ¥è¯¢æ‰€æœ‰å®¢æˆ·</button>
    </div>
</div>


<div class="card">
    <h3>
        âœï¸ å®¢æˆ·æ•°æ®ç¼–è¾‘
        <span id="editingIdDisplay">å½“å‰æœªé€‰æ‹©å®¢æˆ· (æ–°å¢æ¨¡å¼)</span>
    </h3>
    <div class="form-group">
        <input type="hidden" id="editCustomerId" value="">

        <div class="input-container">
            <span class="input-description">å§“å:</span>
            <input type="text" id="name" placeholder="å®¢æˆ·å§“å (å¿…å¡«)" required>
        </div>
        <div class="input-container">
            <span class="input-description">ç”µè¯:</span>
            <input type="text" id="phone" placeholder="è”ç³»ç”µè¯ (é€‰å¡«)">
        </div>
        <div class="input-container">
            <span class="input-description">é‚®ç®±:</span>
            <input type="text" id="email" placeholder="ç”µå­é‚®ç®± (é€‰å¡«)">
        </div>
        <div class="input-container">
            <span class="input-description">è¡Œä¸š:</span>
            <input type="text" id="industry" placeholder="æ‰€å±è¡Œä¸š (é€‰å¡«)">
        </div>
        <div class="input-container">
            <span class="input-description">åœ°å€:</span>
            <input type="text" id="address" placeholder="è¯¦ç»†åœ°å€ (é€‰å¡«)">
        </div>
        <div class="input-container">
            <span class="input-description">å½’å±äºº ID:</span>
            <input type="number" id="ownerId" placeholder="å®¢æˆ·å½’å±äºº ID (å¿…å¡«)" required>
        </div>
        <div class="input-container">
            <span class="input-description">åˆ›å»ºæ—¶é—´:</span>
            <input type="text" id="createTime" placeholder="ç”±ç³»ç»Ÿè‡ªåŠ¨ç”Ÿæˆ" disabled>
        </div>
        <div class="input-container">
            <span class="input-description">æ›´æ–°æ—¶é—´:</span>
            <input type="text" id="updateTime" placeholder="ç”±ç³»ç»Ÿè‡ªåŠ¨æ›´æ–°" disabled>
        </div>
    </div>
    <div>
        <button id="insertBtn" onclick="saveCustomer()">æ–°å¢å®¢æˆ·</button>
        <button id="updateBtn" onclick="saveCustomer()" style="display:none;">æ›´æ–°å®¢æˆ·</button>
        <button id="resetBtn" onclick="resetForm()">å–æ¶ˆ/æ¸…ç©ºè¡¨å•</button>
    </div>
</div>

<div class="card">
    <h3>ğŸ“‹ å®¢æˆ·åˆ—è¡¨</h3>

    <div class="table-responsive">
        <table id="customerTable">
            <thead>
            <tr>
                <th>ID</th>
                <th>å§“å</th>
                <th>ç”µè¯</th>
                <th>é‚®ç®±</th>
                <th>è¡Œä¸š</th>
                <th>åœ°å€</th>
                <th>å½’å±äºº ID</th>
                <th>åˆ›å»ºæ—¶é—´</th>
                <th>æ›´æ–°æ—¶é—´</th>
                <th>æ“ä½œ</th>
            </tr>
            </thead>
            <tbody>
            <tr><td colspan="10" class="text-center">åŠ è½½ä¸­...</td></tr>
            </tbody>
        </table>
    </div>
</div>


<script>
    const baseUrl = 'http://localhost:8080/api/customers';
    let customerCache = [];

    // ä¼˜åŒ–åçš„æ—¶é—´æ ¼å¼åŒ–å‡½æ•° (é€‚é… LocalDate/yyyy-MM-dd å­—ç¬¦ä¸²)
    function formatDateTime(timestamp) {
        if (!timestamp) return 'N/A';
        const date = new Date(timestamp);
        if (isNaN(date.getTime())) {
            console.error('æ—¥æœŸè§£æå¤±è´¥ï¼ŒåŸå§‹å€¼:', timestamp);
            return 'N/A';
        }
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        // ä»…æ˜¾ç¤ºæ—¥æœŸ
        return `${year}-${month}-${day}`;
    }

    // æ˜¾ç¤ºå®¢æˆ·åˆ—è¡¨
    function renderCustomers(customers) {
        const tbody = document.querySelector("#customerTable tbody");
        tbody.innerHTML = "";

        if (Array.isArray(customers)) {
            customerCache = customers;
        } else if (customers) {
            customerCache = [customers];
        } else {
            customerCache = [];
        }


        if (customerCache.length === 0) {
            tbody.innerHTML = '<tr><td colspan="10" class="text-center">æ²¡æœ‰æ‰¾åˆ°å®¢æˆ·ä¿¡æ¯ã€‚</td></tr>';
            return;
        }

        customerCache.forEach(c => {
            const row = `<tr>
            <td class="text-center">${c.id || ''}</td>
            <td class="text-center">${c.name || ''}</td>
            <td class="text-center">${c.phone || ''}</td>
            <td class="text-center">${c.email || ''}</td>
            <td class="text-center">${c.industry || ''}</td>
            <td class="text-center">${c.address || ''}</td>
            <td class="text-center">${c.ownerId || ''}</td>
            <td class="text-center">${formatDateTime(c.createTime)}</td>
            <td class="text-center">${formatDateTime(c.updateTime)}</td>
            <td class="text-center">
                <button class="action-edit" onclick="editCustomer(${c.id})">ç¼–è¾‘</button>
                <button class="action-delete" onclick="deleteCustomerFromList(${c.id})">åˆ é™¤</button>
            </td>
        </tr>`;
            tbody.innerHTML += row;
        });
    }

    // å¤„ç† API å“åº”
    function handleResponse(res) {
        if (!res.ok) {
            return res.json().then(error => {
                throw new Error(error.message || `HTTP error! status: ${res.status}`);
            }).catch(() => {
                throw new Error(`HTTP error! status: ${res.status}`);
            });
        }
        return res.json();
    }

    // ----------------------------------------------------
    // --- æŸ¥è¯¢åŠŸèƒ½ ---
    // ----------------------------------------------------

    // æŸ¥è¯¢æ‰€æœ‰å®¢æˆ· (è°ƒç”¨ /user API)
    function getAllCustomers() {
        document.getElementById('queryCustomerId').value = '';

        fetch(`${baseUrl}/user`)
            .then(handleResponse)
            .then(data => renderCustomers(data))
            .catch(error => {
                console.error('æŸ¥è¯¢æ‰€æœ‰å®¢æˆ·å¤±è´¥:', error);
                alert(`æŸ¥è¯¢æ‰€æœ‰å®¢æˆ·å¤±è´¥ï¼š${error.message}`);
                document.querySelector("#customerTable tbody").innerHTML = `<tr><td colspan="10" class="text-center" style="color: red;">æŸ¥è¯¢å¤±è´¥ï¼š${error.message}</td></tr>`;
            });
    }

    // æ ¹æ® ID æŸ¥è¯¢å®¢æˆ·
    function getCustomerById() {
        const id = document.getElementById('queryCustomerId').value;
        if (!id) {
            alert('è¯·è¾“å…¥å®¢æˆ· ID è¿›è¡ŒæŸ¥è¯¢ã€‚');
            return;
        }

        fetch(`${baseUrl}/id?id=${id}`)
            .then(res => {
                if (res.status === 404) {
                    return Promise.reject(new Error(`å®¢æˆ· ID ${id} æœªæ‰¾åˆ°ã€‚`));
                }
                return handleResponse(res);
            })
            .then(data => {
                renderCustomers(Array.isArray(data) ? data : [data]);
            })
            .catch(error => {
                console.error(`æŸ¥è¯¢å®¢æˆ· ID ${id} å¤±è´¥:`, error);
                alert(`æŸ¥è¯¢å®¢æˆ· ID ${id} å¤±è´¥ï¼š${error.message}`);
                document.querySelector("#customerTable tbody").innerHTML = `<tr><td colspan="10" class="text-center" style="color: red;">æŸ¥è¯¢å¤±è´¥ï¼š${error.message}</td></tr>`;
                customerCache = [];
            });
    }

    // ----------------------------------------------------
    // --- æ–°å¢/æ›´æ–°/åˆ é™¤æ ¸å¿ƒé€»è¾‘ ---
    // ----------------------------------------------------

    // å¡«å……è¡¨å•æ•°æ®ä»¥è¿›è¡Œç¼–è¾‘
    function editCustomer(id) {
        const customer = customerCache.find(c => c.id === id);
        if (!customer) {
            alert('æœªæ‰¾åˆ°è¯¥å®¢æˆ·æ•°æ®ï¼Œè¯·é‡æ–°æŸ¥è¯¢ã€‚');
            return;
        }

        document.getElementById('editCustomerId').value = customer.id;
        document.getElementById('name').value = customer.name || '';
        document.getElementById('phone').value = customer.phone || '';
        document.getElementById('email').value = customer.email || '';
        document.getElementById('industry').value = customer.industry || '';
        document.getElementById('address').value = customer.address || '';
        document.getElementById('ownerId').value = customer.ownerId || '';

        // ç›´æ¥ä½¿ç”¨ formatDateTime çš„è¿”å›ç»“æœ (ä»…æ—¥æœŸå­—ç¬¦ä¸²)
        document.getElementById('createTime').value = formatDateTime(customer.createTime);
        document.getElementById('updateTime').value = formatDateTime(customer.updateTime);

        // åˆ‡æ¢æŒ‰é’®å’Œæ ‡é¢˜æ˜¾ç¤º
        document.getElementById('insertBtn').style.display = 'none';
        document.getElementById('updateBtn').style.display = 'inline-block';
        document.getElementById('editingIdDisplay').textContent = `å½“å‰æ­£åœ¨ç¼–è¾‘å®¢æˆ· ID: ${id}`;

        // æ»šåŠ¨åˆ°ç¼–è¾‘åŒºï¼Œæ–¹ä¾¿æ“ä½œ
        document.getElementById('updateBtn').scrollIntoView({ behavior: 'smooth' });
    }

    // æ¸…ç©ºè¡¨å•å¹¶åˆ‡æ¢å›æ–°å¢æ¨¡å¼
    function resetForm() {
        document.getElementById('editCustomerId').value = '';
        document.getElementById('name').value = '';
        document.getElementById('phone').value = '';
        document.getElementById('email').value = '';
        document.getElementById('industry').value = '';
        document.getElementById('address').value = '';
        document.getElementById('ownerId').value = '';
        document.getElementById('createTime').value = '';
        document.getElementById('updateTime').value = '';

        document.getElementById('insertBtn').style.display = 'inline-block';
        document.getElementById('updateBtn').style.display = 'none';
        document.getElementById('editingIdDisplay').textContent = 'å½“å‰æœªé€‰æ‹©å®¢æˆ· (æ–°å¢æ¨¡å¼)';
    }


    // æ”¶é›†è¡¨å•æ•°æ®
    function getCustomerData() {
        return {
            name: document.getElementById('name').value,
            phone: document.getElementById('phone').value,
            email: document.getElementById('email').value,
            industry: document.getElementById('industry').value,
            address: document.getElementById('address').value,
            ownerId: parseInt(document.getElementById('ownerId').value) || null,
        };
    }

    // ç»Ÿä¸€çš„ä¿å­˜å‡½æ•°ï¼ˆæ–°å¢æˆ–æ›´æ–°ï¼‰
    function saveCustomer() {
        const customerId = document.getElementById('editCustomerId').value;
        const customer = getCustomerData();

        if (!customer.name || !customer.ownerId) {
            alert('å§“åå’Œå½’å±äºº ID æ˜¯å¿…å¡«é¡¹ã€‚');
            return;
        }

        const method = 'POST'; // æ‚¨çš„æ›´æ–°å’Œæ–°å¢éƒ½æ˜¯ POST
        const url = customerId ? `${baseUrl}/id2?id=${customerId}` : `${baseUrl}/insert`;

        fetch(url, {
            method: method,
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(customer)
        })
            .then(handleResponse)
            .then(() => {
                alert(customerId ? `å®¢æˆ· ID ${customerId} æ›´æ–°æˆåŠŸ` : 'æ–°å¢æˆåŠŸ');
                resetForm();
                getAllCustomers(); // åˆ·æ–°æ•°æ®åˆ—è¡¨
            })
            .catch(error => {
                console.error('ä¿å­˜å®¢æˆ·å¤±è´¥:', error);
                alert(`ä¿å­˜å®¢æˆ·å¤±è´¥ï¼š${error.message}`);
            });
    }

    // ä»åˆ—è¡¨è¡Œè§¦å‘çš„åˆ é™¤æ“ä½œ
    function deleteCustomerFromList(id) {
        if (!confirm(`ç¡®å®šè¦åˆ é™¤å®¢æˆ· ID ä¸º ${id} çš„è®°å½•å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ï¼`)) {
            return;
        }

        fetch(`${baseUrl}/id1?id=${id}`, { method: 'DELETE' })
            .then(handleResponse)
            .then(() => { alert('åˆ é™¤æˆåŠŸ');
                if (document.getElementById('editCustomerId').value == id) {
                    resetForm();
                }
                getAllCustomers(); // åˆ·æ–°æ•°æ®åˆ—è¡¨
            })
            .catch(error => {
                console.error(`åˆ é™¤å®¢æˆ· ID ${id} å¤±è´¥:`, error);
                alert(`åˆ é™¤å®¢æˆ·å¤±è´¥ï¼š${error.message}`);
            });
    }

    // åˆå§‹åŒ–ï¼šåŠ è½½æ‰€æœ‰å®¢æˆ·
    // ç›´æ¥è°ƒç”¨å‡½æ•°ï¼Œé¿å…ä¸ç¬¬ä¸‰æ–¹è„šæœ¬çš„ window.onload å†²çª
    getAllCustomers();
</script>

<script>
    window.difyChatbotConfig = {
        token: 'gvDUw0zKVceFTAmc',
        inputs: {
            // æ‚¨å¯ä»¥æ ¹æ®éœ€è¦å®šä¹‰è¾“å…¥å˜é‡
        },
        systemVariables: {
            // user_id: 'YOU CAN DEFINE USER ID HERE',
        },
        userVariables: {
            // avatar_url: 'YOU CAN DEFINE USER AVATAR URL HERE',
        },
    }
</script>
<script
        src="https://udify.app/embed.min.js"
        id="gvDUw0zKVceFTAmc"
        defer>
</script>

</body>
</html>